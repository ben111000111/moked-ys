<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שיבוץ מוקד מצוקה יד שרה | בנים</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/G4vT6X6/image-345ee9.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; color: #1e293b; margin: 0; }
        * { font-style: normal !important; } /* ביטול אותיות מוטות בכל האתר */
        .header-bg { background: white; border-bottom: 2px solid #e2e8f0; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; transition: all 0.2s; }
        .card:hover { border-color: #3b82f6; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .slot-btn { @apply w-full mb-1.5 py-2.5 rounded-xl font-bold text-[13px] border transition-all; }
        .slot-free { @apply border-slate-200 text-slate-400 hover:bg-emerald-50 hover:text-emerald-600 hover:border-emerald-200; }
        .slot-taken { @apply bg-blue-600 border-blue-700 text-white shadow-sm cursor-pointer; }
        .nav-btn { @apply px-5 py-2 rounded-xl text-xs font-bold transition-all border border-slate-200 text-slate-500 bg-white; }
        .nav-btn-active { @apply bg-blue-600 text-white border-blue-600 shadow-md; }
        .night-label { @apply text-[10px] font-bold text-blue-500 block mb-1; }
        .girls-label { @apply bg-pink-50 text-pink-400 text-[10px] py-1 text-center font-bold rounded-lg border border-pink-100; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <header class="header-bg sticky top-0 z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <img src="https://i.ibb.co/G4vT6X6/image-345ee9.png" alt="לוגו יד שרה" class="h-14">
                <div>
                    <h1 class="text-xl font-black text-slate-800 leading-none uppercase">מוקד מצוקה יד שרה</h1>
                    <p class="text-blue-600 font-bold text-xs mt-1">מוקד מצוקה בנים | ניהול שיבוץ</p>
                </div>
            </div>

            <div class="flex flex-col items-center">
                <div id="clock" class="text-2xl font-black text-slate-800 tabular-nums leading-none">00:00:00</div>
                <div id="topHebDate" class="text-blue-600 font-bold text-[10px] mt-1 uppercase tracking-widest">טוען תאריך עברי...</div>
            </div>

            <nav class="flex gap-1.5 bg-slate-100 p-1 rounded-2xl">
                <button onclick="setView('daily')" id="v-daily" class="nav-btn">יומי</button>
                <button onclick="setView('weekly')" id="v-weekly" class="nav-btn nav-btn-active">שבועי</button>
                <button onclick="setView('monthly')" id="v-monthly" class="nav-btn">חודשי</button>
                <button onclick="setView('sabbaths')" id="v-sabbaths" class="nav-btn">שבתות</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8">
        <div id="navControls" class="flex justify-between items-center mb-8">
            <button onclick="move(-1)" class="w-12 h-12 flex items-center justify-center bg-white border rounded-full shadow-sm hover:bg-slate-50">◀</button>
            <div class="text-center">
                <h2 id="periodTitle" class="text-3xl font-black text-slate-800"></h2>
                <div id="parashaBadge" class="mt-1 text-blue-600 font-bold text-lg"></div>
            </div>
            <button onclick="move(1)" class="w-12 h-12 flex items-center justify-center bg-white border rounded-full shadow-sm hover:bg-slate-50">▶</button>
        </div>

        <div id="mainGrid" class="grid gap-6"></div>
    </main>

    <script>
        // הקישור המעודכן שלך
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkF_vyCgXxJhlVHUTHnLr_0-S_AowKE5dVhjZ8iHPCzP6lKV3FTJ7bOIYrBzTWEnIY/exec";
        
        const DAYS = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];
        // רשימת פרשות קבועה
        const PARASHOT = {
            "2026-01-03": "ויחי", "2026-01-10": "שמות", "2026-01-17": "וארא", "2026-01-24": "בא",
            "2026-01-31": "בשלח", "2026-02-07": "יתרו", "2026-02-14": "משפטים", "2026-02-21": "תרומה"
        };

        let viewMode = 'weekly', anchor = new Date(), db = [];

        // שעון ותאריך עברי
        setInterval(async () => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('he-IL', {hour12:false});
            if(!window.hebSet) {
                try {
                    const res = await fetch(`https://www.hebcal.com/converter?cfg=json&gy=${now.getFullYear()}&gm=${now.getMonth()+1}&gd=${now.getDate()}&g2h=1`);
                    const data = await res.json();
                    document.getElementById('topHebDate').innerText = data.hebrew;
                    window.hebSet = true;
                } catch(e) {}
            }
        }, 1000);

        async function load() {
            try { 
                const r = await fetch(SCRIPT_URL); 
                db = await r.json(); 
                render(); 
            } catch(e) { render(); }
        }

        async function render() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-20 font-bold opacity-30 animate-pulse text-xl">מעדכן יומן שיבוץ...</div>';
            document.getElementById('navControls').style.display = (viewMode === 'sabbaths') ? 'none' : 'flex';

            if(viewMode === 'weekly') renderWeekly(grid);
            else if(viewMode === 'daily') renderDaily(grid);
            else if(viewMode === 'monthly') renderMonthly(grid);
            else renderSabbaths(grid);
        }

        function renderWeekly(container) {
            container.className = "flex flex-col gap-8";
            let start = new Date(anchor); start.setDate(anchor.getDate() - anchor.getDay());
            document.getElementById('periodTitle').innerText = "שיבוץ שבועי";
            
            // ימי חול מוצ"ש עד חמישי
            let weekHtml = `<div class="grid grid-cols-1 md:grid-cols-6 gap-3">`;
            const order = [6, 0, 1, 2, 3, 4]; // מוצ"ש, א, ב, ג, ד, ה
            
            order.forEach(i => {
                let d = new Date(start);
                d.setDate(start.getDate() + (i === 6 ? -1 : i));
                let dKey = d.toISOString().split('T')[0];
                let isToday = new Date().toDateString() === d.toDateString();

                weekHtml += `<div class="card p-3 ${isToday ? 'bg-blue-50/30 border-blue-200' : ''}">
                    <div class="text-center border-b pb-2 mb-3">
                        <div class="font-black text-slate-800">${i === 6 ? 'מוצ"ש' : DAYS[i]}</div>
                        <div class="text-[10px] text-slate-400 font-bold">${d.toLocaleDateString('he-IL')}</div>
                    </div>`;

                if(i === 6) {
                    weekHtml += renderSlot(dKey, 'night', 'לילה', '21:00-08:00', 1, `בין מוצ"ש לראשון`);
                } else {
                    weekHtml += renderSlot(dKey, 'morn', 'בוקר', '08:00-15:00', 4, '', true);
                    weekHtml += renderSlot(dKey, 'eve', 'ערב', '15:00-21:00', 2);
                    weekHtml += renderSlot(dKey, 'night', 'לילה', '21:00-08:00', 1, `בין ${DAYS[i]} ל${DAYS[i+1]}`);
                }
                weekHtml += `</div>`;
            });
            weekHtml += `</div>`;

            // סופ"ש נפרד
            let sat = new Date(start); sat.setDate(start.getDate() + 6);
            let fri = new Date(start); fri.setDate(start.getDate() + 5);
            let pName = PARASHOT[sat.toISOString().split('T')[0]] || "פרשת השבוע";
            document.getElementById('parashaBadge').innerText = "שבת פרשת " + pName;

            let weekendHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-100 p-4 rounded-2xl border border-slate-200">
                <div class="card p-4 bg-white shadow-sm">
                    <div class="font-black text-blue-800 mb-3 border-b pb-2 text-center">שישי (בוקר בלבד)</div>
                    ${renderSlot(fri.toISOString().split('T')[0], 'fri_morn', 'בוקר', '08:00-12:00', 1, '', true)}
                </div>
                <div class="card p-4 bg-white shadow-sm">
                    <div class="font-black text-blue-800 mb-3 border-b pb-2 text-center">שבת (בוקר ולילה)</div>
                    <div class="grid grid-cols-2 gap-2">
                        ${renderSlot(fri.toISOString().split('T')[0], 'sat_morn', 'שבת בוקר', 'שישי+שבת', 2)}
                        ${renderSlot(fri.toISOString().split('T')[0], 'sat_night', 'שבת לילה', 'שישי+שבת', 2)}
                    </div>
                </div>
            </div>`;

            container.innerHTML = weekHtml + weekendHtml;
        }

        function renderSlot(date, sid, sname, stime, slots, nightLabel = '', isGirls = false) {
            let html = `<div class="mb-3">
                <div class="flex justify-between items-center px-1 mb-1">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-tighter">${sname}</span>
                    <span class="text-[8px] text-slate-300 font-bold">${stime}</span>
                </div>`;
            if(nightLabel) html += `<span class="night-label">${nightLabel}</span>`;
            if(isGirls) {
                html += `<div class="girls-label">בנות</div>`;
            } else {
                for(let j=0; j<slots; j++) {
                    const b = db.find(x => x.תאריך === date && x.סוג_משמרת === sid); // התאמה לשמות העמודות בשיטס שלך
                    if(!b) html += `<button class="slot-btn slot-free" onclick="openForm('${date}','${sid}','${sname}')">+ בקש</button>`;
                    else html += `<button class="slot-btn slot-taken" onclick="viewB('${date}','${sid}')">${b.שם_מוקדן}</button>`;
                }
            }
            return html + `</div>`;
        }

        function setView(v) {
            viewMode = v;
            ['v-daily','v-weekly','v-monthly','v-sabbaths'].forEach(id => {
                document.getElementById(id).classList.toggle('nav-btn-active', id === 'v-'+v);
            });
            render();
        }

        function move(d) {
            if(viewMode === 'weekly') anchor.setDate(anchor.getDate() + (7*d));
            else anchor.setDate(anchor.getDate() + d);
            render();
        }

        function openForm(date, sid, sname) {
            // לוגיקה לפתיחת המודאל שביקשת
            alert("פונקציית הבקשה תיפתח כאן עבור: " + sname + " בתאריך " + date);
        }

        function viewB(date, sid) {
            // לוגיקה לצפייה בפרטים
            const b = db.find(x => x.תאריך === date && x.סוג_משמרת === sid);
            alert("מוקדן משובץ: " + b.שם_מוקדן + "\nטלפון: " + b.טלפון);
        }

        load();
    </script>
</body>
</html>

