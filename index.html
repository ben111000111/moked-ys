<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×©×™×‘×•×¥ ×©×‘×•×¢×™ | ××•×§×“ ×™×“ ×©×¨×”</title>
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .nav-link { @apply px-3 py-2 rounded-xl text-[12px] font-bold border border-slate-200 bg-white flex items-center gap-1 transition-all hover:bg-slate-50; }
        .nav-link-active { @apply bg-blue-600 text-white border-blue-600 hover:bg-blue-700; }
        .slot-btn { @apply w-full mb-1.5 py-2.5 rounded-xl font-bold text-[13px] border transition-all shadow-sm; }
        .slot-free { @apply border-slate-200 text-slate-400 hover:bg-emerald-50 hover:text-emerald-600; }
        .slot-taken { @apply bg-blue-600 border-blue-700 text-white font-bold; }
        .card { @apply bg-white p-4 rounded-2xl border border-slate-200 shadow-sm h-full; }
    </style>
</head>
<body class="min-h-screen pb-20">
    <script>if(localStorage.getItem('user_auth') !== 'true') window.location.replace('login.html');</script>

    <header class="bg-white border-b-2 border-slate-200 sticky top-0 z-50 px-6 py-4 flex justify-between items-center text-right">
        <div class="flex items-center gap-4">
            <img src="logo.png" class="h-14">
            <div>
                <h1 id="welcomeMsg" class="text-lg font-black text-slate-800 leading-none">×©×œ×•×...</h1>
                <p id="timeGreeting" class="text-blue-600 font-bold text-xs mt-1 uppercase"></p>
            </div>
        </div>

        <div class="hidden md:flex flex-col items-center">
            <div id="clock" class="text-2xl font-black text-slate-800 tabular-nums leading-tight">00:00:00</div>
            <div id="topHebDate" class="text-blue-600 font-bold text-[10px] tracking-widest uppercase">×˜×•×¢×Ÿ ×ª××¨×™×š...</div>
        </div>

        <nav class="flex gap-2">
            <a href="index.html" class="nav-link nav-link-active">×‘×™×ª</a>
            <a href="sabbaths.html" class="nav-link">×©×‘×ª×•×ª</a>
            <a href="profile.html" class="nav-link bg-blue-50 text-blue-700 border-blue-200">ğŸ‘¤ ××–×•×¨ ××™×©×™</a>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 text-right">
        <div class="flex justify-between items-center mb-8 bg-white p-4 rounded-3xl border shadow-sm">
            <button onclick="changeWeek(-1)" class="w-10 h-10 border rounded-full hover:bg-slate-50 transition-colors">â—€</button>
            <div class="text-center">
                <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight">×¡×™×“×•×¨ ×¢×‘×•×“×” ×©×‘×•×¢×™</h2>
                <div id="parashaBadge" class="text-blue-600 font-bold text-sm italic">×˜×•×¢×Ÿ ×¤×¨×©×”...</div>
            </div>
            <button onclick="changeWeek(1)" class="w-10 h-10 border rounded-full hover:bg-slate-50 transition-colors">â–¶</button>
        </div>

        <div id="mainGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8"></div>
        <div id="weekendGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-slate-200 pt-8"></div>
    </main>

    <div id="modal" class="fixed inset-0 z-[100] hidden bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 text-right">
        <div class="bg-white w-full max-w-lg rounded-3xl p-8 shadow-2xl border border-white">
            <h3 class="text-2xl font-black mb-2">×‘×§×©×ª ×©×™×‘×•×¥</h3>
            <div id="modalInfo" class="bg-blue-50 p-4 rounded-2xl mb-6 text-blue-800 font-bold text-sm"></div>
            <div class="space-y-4 text-right">
                <input id="f-name" type="text" placeholder="×©× ××œ×" class="w-full p-3 rounded-xl border bg-slate-50 font-bold outline-none text-right">
                <input id="f-phone" type="tel" placeholder="×˜×œ×¤×•×Ÿ" class="w-full p-3 rounded-xl border bg-slate-50 font-bold outline-none text-right">
            </div>
            <div class="mt-8 flex flex-col gap-3 text-right">
                <button id="submitBtn" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-lg">×©×œ×— ×‘×§×©×”</button>
                <button onclick="closeModal()" class="w-full py-2 text-slate-400 font-bold hover:text-slate-600 transition-colors">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        let db = [], anchor = new Date();

        // ×©×¢×•×Ÿ ×•×ª××¨×™×š ×¢×‘×¨×™
        setInterval(async () => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('he-IL', {hour12:false});
            if(!window.hebSet) {
                try {
                    const res = await fetch(`https://www.hebcal.com/converter?cfg=json&gy=${now.getFullYear()}&gm=${now.getMonth()+1}&gd=${now.getDate()}&g2h=1`);
                    const data = await res.json();
                    document.getElementById('topHebDate').innerText = data.hebrew;
                    window.hebSet = true;
                } catch(e) {}
            }
        }, 1000);

        function updateGreeting() {
            const profile = JSON.parse(localStorage.getItem('user_profile') || '{"name":"××•×§×“×Ÿ"}');
            const hour = new Date().getHours();
            let greet = hour < 5 || hour >= 21 ? "×œ×™×œ×” ×˜×•×‘" : hour < 12 ? "×‘×•×§×¨ ×˜×•×‘" : hour < 17 ? "×¦×”×¨×™×™× ×˜×•×‘×™×" : "×¢×¨×‘ ×˜×•×‘";
            document.getElementById('welcomeMsg').innerText = `×©×œ×•×, ${profile.name}`;
            document.getElementById('timeGreeting').innerText = greet;
        }

        async function load() {
            try {
                const r = await fetch(CONFIG.SCRIPT_URL);
                db = await r.json();
                render();
            } catch(e) { console.error("Error loading data", e); }
        }

        async function render() {
            const grid = document.getElementById('mainGrid');
            const weekend = document.getElementById('weekendGrid');
            
            let sun = new Date(anchor); sun.setDate(anchor.getDate() - anchor.getDay());
            let satNight = new Date(sun); satNight.setDate(sun.getDate() - 1);

            // ×¢×“×›×•×Ÿ ×¤×¨×©×”
            let sat = new Date(sun); sat.setDate(sun.getDate() + 6);
            let satKey = sat.toISOString().split('T')[0];
            try {
                const pRes = await fetch(`https://www.hebcal.com/hebcal?v=1&cfg=json&maj=on&year=${sat.getFullYear()}&month=${sat.getMonth()+1}`);
                const pData = await pRes.json();
                const item = pData.items.find(i => i.category === "parashat" && i.date === satKey);
                document.getElementById('parashaBadge').innerText = item ? `×©×‘×ª ×¤×¨×©×ª ${item.hebrew}` : "×©×‘×ª ×¤×¨×©×ª ×”×©×‘×•×¢";
            } catch(e) { document.getElementById('parashaBadge').innerText = "×©×‘×ª ×¤×¨×©×ª ×”×©×‘×•×¢"; }

            let mainHtml = "";
            const WEEKDAYS = ['××•×¦"×©', '×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™'];
            for(let i=0; i<6; i++) {
                let d = new Date(satNight); d.setDate(satNight.getDate() + i);
                let dKey = d.toISOString().split('T')[0];
                const hRes = await fetch(`https://www.hebcal.com/converter?cfg=json&gy=${d.getFullYear()}&gm=${d.getMonth()+1}&gd=${d.getDate()}&g2h=1`);
                const hData = await hRes.json();

                mainHtml += `<div class="card">
                    <div class="text-center border-b pb-2 mb-3">
                        <div class="font-black text-slate-700">${WEEKDAYS[i]}</div>
                        <div class="text-[10px] text-blue-500 font-bold">${hData.hebrew}</div>
                    </div>`;
                
                if(WEEKDAYS[i] === '××•×¦"×©') {
                    mainHtml += renderSlot(dKey, 'night', '×œ×™×œ×”', '××•×¦"×©');
                } else {
                    mainHtml += renderSlot(dKey, 'morn', '×‘×•×§×¨', '', i < 5);
                    mainHtml += renderSlot(dKey, 'eve', '×¢×¨×‘');
                    mainHtml += renderSlot(dKey, 'night', '×œ×™×œ×”', '××©××¨×ª ×œ×™×œ×”');
                }
                mainHtml += `</div>`;
            }
            grid.innerHTML = mainHtml;

            let fri = new Date(sun); fri.setDate(sun.getDate() + 5);
            let friKey = fri.toISOString().split('T')[0];
            weekend.innerHTML = `
                <div class="card bg-emerald-50/30 border-emerald-100">
                    <div class="text-center border-b border-emerald-100 pb-2 mb-3 font-black text-emerald-800 text-lg">×™×•× ×©×™×©×™ (8:00-12:00)</div>
                    ${renderSlot(friKey, 'fri_morn', '×‘×•×§×¨ ×©×™×©×™', '', true)}
                </div>
                <div class="card bg-blue-50/30 border-blue-100 text-right">
                    <div class="text-center border-b border-blue-100 pb-2 mb-3 font-black text-blue-800 text-lg">×©×‘×ª ×§×•×“×©</div>
                    <div class="grid grid-cols-2 gap-2">
                        ${renderSlot(friKey, 'sat_morn', '×‘×•×§×¨ ×©×‘×ª')}
                        ${renderSlot(friKey, 'sat_night', '×œ×™×œ×” ×©×‘×ª')}
                    </div>
                </div>`;
        }

        function renderSlot(date, sid, sname, note, girls) {
            const b = db.find(x => x.×ª××¨×™×š === date && x.×¡×•×’_××©××¨×ª === sid);
            let html = `<div class="mb-3 text-right">
                <div class="text-[9px] font-black text-slate-400 uppercase tracking-wider">${sname}</div>`;
            if(girls) html += `<div class="bg-pink-100 text-pink-600 text-[10px] py-1 text-center font-bold rounded-lg mb-1 border border-pink-200 italic">×‘× ×•×ª ×‘×œ×‘×“</div>`;
            if(b) html += `<button class="slot-btn slot-taken" onclick="alert('×˜×œ×¤×•×Ÿ ×œ×ª×™××•×: ${b.×˜×œ×¤×•×Ÿ}')">${b.×©×_××•×§×“×Ÿ}</button>`;
            else html += `<button onclick="openRequest('${date}','${sid}','${sname}')" class="slot-btn slot-free">+ ×‘×§×©</button>`;
            return html + `</div>`;
        }

        function openRequest(date, sid, sname) {
            const profile = JSON.parse(localStorage.getItem('user_profile') || '{}');
            document.getElementById('f-name').value = profile.name || '';
            document.getElementById('f-phone').value = profile.phone || '';
            document.getElementById('modalInfo').innerText = `${sname} | ${date}`;
            document.getElementById('submitBtn').onclick = () => submit(date, sid);
            document.getElementById('modal').classList.remove('hidden');
        }

        async function submit(date, sid) {
            const n = document.getElementById('f-name').value, p = document.getElementById('f-phone').value;
            if(!n || !p) return alert("× × ×œ××œ× ×©× ×•×˜×œ×¤×•×Ÿ");
            const sBtn = document.getElementById('submitBtn');
            sBtn.disabled = true; sBtn.innerText = "×©×•×œ×—...";
            
            await fetch(CONFIG.SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'add', date, shiftId: sid, name: n, phone: p }) });
            alert("×”×‘×§×©×” × ×©×œ×—×” ×œ×× ×”×œ ×”××•×§×“!");
            location.reload();
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }
        function changeWeek(d) { anchor.setDate(anchor.getDate() + (7*d)); render(); }
        
        updateGreeting(); load();
    </script>
</body>
</html>
